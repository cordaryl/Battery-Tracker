<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BatteryCycle Track</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        html { -webkit-tap-highlight-color: transparent; }
        body { padding-bottom: env(safe-area-inset-bottom); }
        
        @media print {
            @page { margin: 0.5cm; }
            body { background: white !important; color: black !important; }
            .no-print { display: none !important; }
            .print-view { display: block !important; }
            /* Boxed table for print */
            table.print-bordered { border-collapse: collapse; width: 100%; }
            table.print-bordered th, table.print-bordered td { border: 1px solid #000; padding: 6px; }
            /* Ensure colors print */
            .print-color-exact { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300 flex flex-col">
    <div id="root" class="flex-1 flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Battery, Recycle, Plus, Trash2, BarChart3, Leaf, History, AlertCircle, Save, Scale, 
            Settings, Search, Building, Zap, Clock, Moon, Sun, Edit2, X, Printer, CheckSquare, 
            Square, Palette, Type, Calendar, Archive, RefreshCcw, Layout, Box, Database, 
            Download, Upload, Camera, Loader2, SearchCode, ChevronRight, ChevronDown, Folder, 
            FileText, Library, AlertTriangle, ShieldCheck, FlipHorizontal, Image as ImageIcon,
            PenTool, Sparkles, Filter, ToggleLeft, ToggleRight, Layers, MoreHorizontal, Info, Briefcase
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, enableIndexedDbPersistence, writeBatch } from 'firebase/firestore';

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3SysfdCs1uBypC_JjHuWvpvI2mhS9LZ4",
            authDomain: "battery-recyle-tracker.firebaseapp.com",
            projectId: "battery-recyle-tracker",
            storageBucket: "battery-recyle-tracker.firebasestorage.app",
            messagingSenderId: "622740135754",
            appId: "1:622740135754:web:05b76f79e7d1c2adeaabb3",
            measurementId: "G-7DGFYQ72S1"
        };
        const GEMINI_API_KEY = ""; // Optional

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        try { enableIndexedDbPersistence(db).catch(() => {}); } catch (e) {}

        // --- DATA ---
        const INITIAL_BATTERY_DB = [
            { manufacturer: "CSB", model: "HRL 1234W", type: "Lead-Acid", weight: 5.7, ah: 9, life: "5-8 Years" },
            { manufacturer: "CSB", model: "GP 1272", type: "Lead-Acid", weight: 5.3, ah: 7.2, life: "3-5 Years" },
            { manufacturer: "CSB", model: "GP 12120", type: "Lead-Acid", weight: 8.1, ah: 12, life: "3-5 Years" },
            { manufacturer: "CSB", model: "GP 12170", type: "Lead-Acid", weight: 12.1, ah: 17, life: "3-5 Years" },
            { manufacturer: "CSB", model: "HRL 12500W", type: "Lead-Acid", weight: 97, ah: 125, life: "8-10 Years" },
            
            { manufacturer: "Universal", model: "UB1223 (2.3Ah)", type: "Lead-Acid", weight: 1.6, ah: 2.3, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB1250 (5Ah)", type: "Lead-Acid", weight: 3.5, ah: 5, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB1270 (7Ah)", type: "Lead-Acid", weight: 4.8, ah: 7, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB1280 (8Ah)", type: "Lead-Acid", weight: 4.9, ah: 8, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB1290 (9Ah)", type: "Lead-Acid", weight: 5.1, ah: 9, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB12100 (10Ah)", type: "Lead-Acid", weight: 7.1, ah: 10, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB12120 (12Ah)", type: "Lead-Acid", weight: 8.2, ah: 12, life: "3-5 Years" },
            { manufacturer: "Universal", model: "UB12180 (18Ah)", type: "Lead-Acid", weight: 11.6, ah: 18, life: "3-5 Years" },
            
            { manufacturer: "Power-Sonic", model: "PS-1270", type: "Lead-Acid", weight: 4.8, ah: 7, life: "3-5 Years" },
            { manufacturer: "Power-Sonic", model: "PS-1290", type: "Lead-Acid", weight: 5.1, ah: 9, life: "3-5 Years" },
            
            { manufacturer: "APC", model: "RBC2", type: "Lead-Acid", weight: 5.5, ah: 7, life: "3-5 Years" },
            { manufacturer: "APC", model: "RBC7", type: "Lead-Acid", weight: 24.5, ah: 18, life: "3-5 Years" },
            { manufacturer: "APC", model: "RBC12", type: "Lead-Acid", weight: 42.1, ah: 7, life: "3-5 Years" },
            { manufacturer: "APC", model: "RBC44", type: "Lead-Acid", weight: 76.2, ah: 5, life: "3-5 Years" },
            
            { manufacturer: "Enersys", model: "DataSafe 12HX205", type: "Lead-Acid", weight: 42, ah: 44, life: "10 Years" },
            { manufacturer: "Enersys", model: "DataSafe 12HX300", type: "Lead-Acid", weight: 60, ah: 71, life: "10 Years" },
            { manufacturer: "Enersys", model: "DataSafe 12HX330", type: "Lead-Acid", weight: 65, ah: 78, life: "10 Years" },
            { manufacturer: "Enersys", model: "DataSafe 12HX400", type: "Lead-Acid", weight: 80, ah: 92, life: "10 Years" },
            { manufacturer: "Enersys", model: "DataSafe 12HX505", type: "Lead-Acid", weight: 104, ah: 115, life: "10 Years" },
            { manufacturer: "Enersys", model: "DataSafe 12HX540", type: "Lead-Acid", weight: 106, ah: 123, life: "10 Years" },
            
            { manufacturer: "C&D", model: "UPS12-300MR", type: "Lead-Acid", weight: 58, ah: 78, life: "10 Years" },
            { manufacturer: "C&D", model: "UPS12-350MR", type: "Lead-Acid", weight: 68, ah: 90, life: "10 Years" },
            { manufacturer: "C&D", model: "UPS12-400MR", type: "Lead-Acid", weight: 76, ah: 102, life: "10 Years" },
            { manufacturer: "C&D", model: "UPS12-490MR", type: "Lead-Acid", weight: 98, ah: 138, life: "10 Years" },
            { manufacturer: "C&D", model: "UPS12-540MR", type: "Lead-Acid", weight: 105, ah: 148, life: "10 Years" },
            { manufacturer: "C&D", model: "JC 400 (Wet)", type: "Wet Cell", weight: 65, ah: 400, life: "20 Years" },
            
            { manufacturer: "Leoch", model: "LP12-7.0", type: "Lead-Acid", weight: 4.7, ah: 7, life: "3-5 Years" },
            { manufacturer: "Leoch", model: "LP12-9.0", type: "Lead-Acid", weight: 5.5, ah: 9, life: "3-5 Years" },
            { manufacturer: "Leoch", model: "XP12-300", type: "Lead-Acid", weight: 57, ah: 75, life: "10 Years" },
            { manufacturer: "Leoch", model: "XP12-400", type: "Lead-Acid", weight: 75, ah: 100, life: "10 Years" },

            { manufacturer: "Deka", model: "12AVR100ET", type: "Lead-Acid", weight: 69, ah: 100, life: "10 Years" },
            { manufacturer: "Deka", model: "12AVR145ET", type: "Lead-Acid", weight: 104, ah: 145, life: "10 Years" },
            { manufacturer: "Deka", model: "12AVR170ET", type: "Lead-Acid", weight: 118, ah: 170, life: "10 Years" },
            
            { manufacturer: "Amstron", model: "AP-1270", type: "Lead-Acid", weight: 4.8, ah: 7, life: "3-5 Years" },
            { manufacturer: "Amstron", model: "AP-1290", type: "Lead-Acid", weight: 5.4, ah: 9, life: "3-5 Years" },

            { manufacturer: "Trojan", model: "T-105 (6V)", type: "Wet Cell", weight: 62, ah: 225, life: "5-7 Years" },
            { manufacturer: "Trojan", model: "L16P (6V)", type: "Wet Cell", weight: 115, ah: 360, life: "5-8 Years" },
            
            { manufacturer: "Tesla", model: "Powerwall 2", type: "Li-ion", weight: 251, ah: 0, life: "10-15 Years" },
            { manufacturer: "Tesla", model: "Powerwall 3", type: "Li-ion", weight: 287, ah: 0, life: "10-15 Years" },
            
            { manufacturer: "LG Chem", model: "RESU 10H", type: "Li-ion", weight: 214, ah: 63, life: "10 Years" },
            
            { manufacturer: "Enphase", model: "IQ Battery 10", type: "Li-ion", weight: 346, ah: 0, life: "10-15 Years" },
        ];

        const THEMES = {
            emerald: { primary: 'bg-emerald-600', text: 'text-emerald-700', border: 'border-l-emerald-500' },
            blue: { primary: 'bg-blue-600', text: 'text-blue-700', border: 'border-l-blue-500' },
            violet: { primary: 'bg-violet-600', text: 'text-violet-700', border: 'border-l-violet-500' },
            slate: { primary: 'bg-slate-700', text: 'text-slate-700', border: 'border-l-slate-600' }
        };

        // --- COMPONENTS ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const TypeBadge = ({ type }) => {
            const t = String(type || 'Other');
            let colorClass = 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300';
            if(t.includes('Li-ion')) colorClass = 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300';
            if(t.includes('Wet')) colorClass = 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300';
            return <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${colorClass}`}>{t}</span>;
        };

        const StatusIcon = ({ date }) => {
            if (!date) return <div className="w-2.5 h-2.5 rounded-full bg-slate-300 dark:bg-slate-600 print-color-exact"></div>;
            const days = (new Date(date) - new Date()) / (1000 * 60 * 60 * 24);
            if (days < 0) return <div className="w-3 h-3 rounded-full bg-red-500 border border-red-600 print-color-exact" title="Expired"></div>;
            if (days < 60) return <div className="w-3 h-3 rounded-full bg-amber-500 border border-amber-600 print-color-exact" title="Expiring Soon"></div>;
            return <div className="w-3 h-3 rounded-full bg-emerald-500 border border-emerald-600 print-color-exact" title="Good"></div>;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${m}/${d}/${y}`;
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dbSubTab, setDbSubTab] = useState('explorer');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [printMode, setPrintMode] = useState(false);
            const [scanning, setScanning] = useState(false);
            const [searchingModel, setSearchingModel] = useState(false);
            const [addingLibItem, setAddingLibItem] = useState(false);
            const [archiveGroupBy, setArchiveGroupBy] = useState('jobName'); // 'jobName', 'location', 'manufacturer'
            
            // Data
            const [logs, setLogs] = useState([]);
            const [customLibrary, setCustomLibrary] = useState([]);
            const [savedSources, setSavedSources] = useState([]);
            
            // UI State
            const [dbSearch, setDbSearch] = useState('');
            const [expandedFolders, setExpandedFolders] = useState(new Set());
            const [expandedLibFolders, setExpandedLibFolders] = useState(new Set());
            const [selectedLogIds, setSelectedLogIds] = useState(new Set());
            const [newLibData, setNewLibData] = useState({ id: null, manufacturer: '', model: '', type: 'Lead-Acid', weight: '', ah: '', life: '' });

            const [appSettings, setAppSettings] = useState({
                companyName: 'BatteryCycle Track', logoUrl: '', themeColor: 'emerald', fontStyle: 'font-sans', 
                showProtocols: true, dynamicReports: false, showDates: true, reportLogo: false, invertLogoPrint: false
            });

            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({
                batteryModel: '', manufacturer: '', type: 'Lead-Acid', lithiumType: '', unitWeight: '', totalWeight: '', count: '', 
                ampHours: '', expectedLife: '', dateCode: '', notes: '', location: '', installDate: '', expiryDate: ''
            });
            
            const [suggestions, setSuggestions] = useState([]);
            const theme = THEMES[appSettings.themeColor] || THEMES.emerald;

            const activeLogs = useMemo(() => logs.filter(l => !l.archived), [logs]);
            const archivedLogs = useMemo(() => logs.filter(l => l.archived), [logs]);
            
            const allTimeStats = useMemo(() => {
                return logs.reduce((acc, l) => {
                    acc.weight += Number(l.weight || 0);
                    acc.count += Number(l.count || 0);
                    return acc;
                }, { weight: 0, count: 0 });
            }, [logs]);

            const fullLibrary = useMemo(() => {
                const customMap = new Map();
                customLibrary.forEach(i => {
                    const key = ((i.manufacturer||"").trim() + (i.model||"").trim()).toLowerCase();
                    customMap.set(key, i);
                });
                const merged = [];
                INITIAL_BATTERY_DB.forEach(initItem => {
                    const key = ((initItem.manufacturer||"").trim() + (initItem.model||"").trim()).toLowerCase();
                    if (!customMap.has(key)) {
                        merged.push(initItem);
                    }
                });
                return [...merged, ...customLibrary].sort((a,b) => (a.manufacturer||'').localeCompare(b.manufacturer||''));
            }, [customLibrary]);

            useEffect(() => { document.documentElement.classList.toggle('dark', isDarkMode); }, [isDarkMode]);
            useEffect(() => { signInAnonymously(auth); return onAuthStateChanged(auth, setUser); }, []);
            
            useEffect(() => {
                if (!user) return;
                const unsubLogs = onSnapshot(collection(db, 'recycling_logs'), s => setLogs(s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0))));
                const unsubLib = onSnapshot(collection(db, 'custom_library'), s => setCustomLibrary(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubSrc = onSnapshot(collection(db, 'saved_sources'), s => setSavedSources(s.docs.map(d => String(d.data().name))));
                getDoc(doc(db, 'settings', 'global_config')).then(s => s.exists() && setAppSettings(prev => ({...prev, ...s.data()})));
                setLoading(false);
                return () => { unsubLogs(); unsubLib(); unsubSrc(); };
            }, [user]);

            useEffect(() => {
                const u = parseFloat(formData.unitWeight) || 0;
                const c = parseInt(formData.count) || 0;
                if(u > 0 && c > 0) setFormData(p => ({...p, totalWeight: (u*c).toFixed(1)}));
            }, [formData.unitWeight, formData.count]);

            useEffect(() => {
                if(formData.installDate && formData.expectedLife) {
                    const lifeStr = String(formData.expectedLife);
                    const years = parseInt(lifeStr.match(/\d+/)?.[0] || "0");
                    if(years > 0) {
                        const d = new Date(formData.installDate);
                        d.setFullYear(d.getFullYear() + years);
                        setFormData(p => ({...p, expiryDate: d.toISOString().split('T')[0]}));
                    }
                }
            }, [formData.installDate, formData.expectedLife]);

            const saveRecord = async (e) => {
                e.preventDefault();
                if (!user) return;
                try {
                    const payload = { ...formData, weight: parseFloat(formData.totalWeight)||0, unitWeight: parseFloat(formData.unitWeight)||0, count: parseInt(formData.count)||0, dateStr: new Date().toLocaleDateString(), archived: false };
                    
                    if(formData.location && !savedSources.includes(formData.location)) await addDoc(collection(db, 'saved_sources'), {name: formData.location});
                    
                    const modelKey = ((formData.manufacturer||"").trim() + (formData.batteryModel||"").trim()).toLowerCase();
                    const exists = fullLibrary.some(b => ((b.manufacturer||"").trim() + (b.model||"").trim()).toLowerCase() === modelKey);
                    if (!exists && formData.batteryModel && formData.manufacturer) {
                        await addDoc(collection(db, 'custom_library'), { manufacturer: formData.manufacturer, model: formData.batteryModel, type: formData.type, weight: parseFloat(formData.unitWeight)||0, ah: formData.ampHours, life: formData.expectedLife });
                    }

                    if(editingId) await updateDoc(doc(db, 'recycling_logs', editingId), payload);
                    else await addDoc(collection(db, 'recycling_logs'), {...payload, createdAt: serverTimestamp()});
                    
                    setEditingId(null);
                    setFormData({ batteryModel: '', manufacturer: '', type: 'Lead-Acid', lithiumType: '', unitWeight: '', totalWeight: '', count: '', ampHours: '', expectedLife: '', dateCode: '', notes: '', location: '', installDate: '', expiryDate: '' });
                    setActiveTab('dashboard');
                } catch(err) { console.error(err); alert("Error saving. Check numeric fields."); }
            };

            const completeJob = async () => {
                if(selectedLogIds.size === 0) return;
                const jobName = prompt("Enter Job/Log Name (e.g., Server Room B - Replacement)", `Service - ${new Date().toLocaleDateString()}`);
                if(!jobName) return;
                
                const batch = writeBatch(db);
                selectedLogIds.forEach(id => {
                    batch.update(doc(db, 'recycling_logs', id), { 
                        archived: true, 
                        jobName: jobName, 
                        jobDate: new Date().toISOString() 
                    });
                });
                await batch.commit();
                setSelectedLogIds(new Set());
                alert(`Job "${jobName}" Created & Archived!`);
            };

            const saveSettings = async () => {
                if (!user) return;
                await setDoc(doc(db, 'settings', 'global_config'), appSettings);
                alert("Settings Saved!");
            };

            const handleNewLibSubmit = async (e) => {
                e.preventDefault();
                const dataToSave = { manufacturer: newLibData.manufacturer, model: newLibData.model, type: newLibData.type, weight: parseFloat(newLibData.weight)||0, ah: newLibData.ah, life: newLibData.life };
                if(newLibData.id) await updateDoc(doc(db, 'custom_library', newLibData.id), dataToSave);
                else await addDoc(collection(db, 'custom_library'), dataToSave);
                setAddingLibItem(false);
                setNewLibData({ id: null, manufacturer: '', model: '', type: 'Lead-Acid', weight: '', ah: '', life: '' });
            };

            const handleEditLibItem = (e, item) => {
                e.stopPropagation();
                setNewLibData({ id: item.id || null, manufacturer: item.manufacturer || '', model: item.model || '', type: item.type || 'Lead-Acid', weight: String(item.weight || ''), ah: String(item.ah || ''), life: String(item.life || '') });
                setAddingLibItem(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            
            const handleDeleteLibItem = async (e, item) => {
                e.stopPropagation();
                if (!item.id) { alert("Cannot delete built-in items."); return; }
                if(confirm("Delete this library item?")) await deleteDoc(doc(db, 'custom_library', item.id));
            };

            const handleModelSearch = async (val) => {
                setFormData(p => ({...p, batteryModel: val}));
                if(val.length > 1) {
                    const s = val.toLowerCase();
                    setSuggestions(fullLibrary.filter(b => (b.model||'').toLowerCase().includes(s) || (b.manufacturer||'').toLowerCase().includes(s)));
                } else setSuggestions([]);
            };

            const selectBattery = (b) => {
                setFormData(p => ({ ...p, batteryModel: b.model, manufacturer: b.manufacturer, type: b.type, unitWeight: String(b.weight), ampHours: String(b.ah||''), expectedLife: String(b.life||'') }));
                setSuggestions([]);
            };

            const aiScan = async (e) => {
                const file = e.target.files[0]; if(!file) return;
                if(!GEMINI_API_KEY) { alert("API Key missing."); return; }
                setScanning(true);
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{text: "Analyze battery label. Return JSON: manufacturer, model, type, weight (lbs), ah, life."}, {inlineData: {mimeType: file.type, data: reader.result.split(',')[1]}}] }] }) });
                        const data = await res.json();
                        const json = JSON.parse(data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0]);
                        setFormData(p => ({...p, batteryModel: json.model||'', manufacturer: json.manufacturer||'', type: json.type||'Lead-Acid', unitWeight: String(json.weight||''), ampHours: String(json.ah||''), expectedLife: String(json.life||'')}));
                    } catch(err) { console.error(err); alert("Scan failed."); }
                    setScanning(false);
                };
                reader.readAsDataURL(file);
            };

            const aiTextSearch = async () => {
                if(!GEMINI_API_KEY || !formData.batteryModel) return;
                setSearchingModel(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{text: `Search specs for battery: ${formData.batteryModel}. Return JSON: manufacturer, type, weight (lbs), ah, life.`}] }] }) });
                    const data = await res.json();
                    const json = JSON.parse(data.candidates[0].content.parts[0].text.match(/\{[\s\S]*\}/)[0]);
                    setFormData(p => ({...p, manufacturer: json.manufacturer||p.manufacturer, type: json.type||p.type, unitWeight: String(json.weight||p.unitWeight), ampHours: String(json.ah||p.ampHours), expectedLife: String(json.life||p.expectedLife)}));
                } catch(err) { alert("AI Search failed."); }
                setSearchingModel(false);
            };

            const getGroupedLogs = (data, groupBy) => {
                const groups = {};
                data.filter(l => (l.location||'').toLowerCase().includes(dbSearch.toLowerCase()) || (l.batteryModel||'').toLowerCase().includes(dbSearch.toLowerCase()))
                    .forEach(l => {
                        let k = 'Unknown';
                        if (groupBy === 'jobName') k = l.jobName || 'Unassigned Logs';
                        else k = l[groupBy] || 'Unknown';
                        if(!groups[k]) groups[k] = [];
                        groups[k].push(l);
                    });
                return groups;
            };

            const getGroupedLibrary = (data) => {
                const groups = {};
                data.filter(l => (l.model||'').toLowerCase().includes(dbSearch.toLowerCase()) || (l.manufacturer||'').toLowerCase().includes(dbSearch.toLowerCase()))
                    .forEach(l => {
                        const k = l.manufacturer || 'Generic';
                        if(!groups[k]) groups[k] = [];
                        groups[k].push(l);
                    });
                return groups;
            };

            const groupedActive = useMemo(() => getGroupedLogs(activeLogs, 'location'), [activeLogs, dbSearch]);
            const groupedArchive = useMemo(() => getGroupedLogs(archivedLogs, archiveGroupBy), [archivedLogs, dbSearch, archiveGroupBy]);
            const groupedLib = useMemo(() => getGroupedLibrary(fullLibrary), [fullLibrary, dbSearch]);

            const toggleArchive = async (id, status) => {
                if (!user) return;
                await updateDoc(doc(db, 'recycling_logs', id), { archived: !status });
            };

            const batchRestore = async () => {
                const batch = writeBatch(db);
                selectedLogIds.forEach(id => batch.update(doc(db, 'recycling_logs', id), { archived: false }));
                await batch.commit(); setSelectedLogIds(new Set()); alert("Restored.");
            };

            const batchDelete = async () => {
                if(!confirm("Permanently delete?")) return;
                const batch = writeBatch(db);
                selectedLogIds.forEach(id => batch.delete(doc(db, 'recycling_logs', id)));
                await batch.commit(); setSelectedLogIds(new Set()); alert("Deleted.");
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-50 dark:bg-slate-950 text-slate-400"><Loader2 className="animate-spin mr-2" /> Loading...</div>;

            // --- PRINT REPORT ---
            if (printMode) {
                const source = activeTab === 'archives' ? archivedLogs : activeLogs;
                const pLogs = selectedLogIds.size > 0 ? source.filter(l => selectedLogIds.has(l.id)) : source;
                let title = appSettings.companyName;
                if (appSettings.dynamicReports) {
                    if (archiveGroupBy === 'location') {
                        const uniqueLocs = [...new Set(pLogs.map(l => l.location))];
                        if (uniqueLocs.length === 1) title = uniqueLocs[0];
                    } else if (archiveGroupBy === 'manufacturer') {
                        const uniqueManuf = [...new Set(pLogs.map(l => l.manufacturer))];
                        if (uniqueManuf.length === 1) title = uniqueManuf[0];
                    } else if (archiveGroupBy === 'jobName') {
                         const uniqueJob = [...new Set(pLogs.map(l => l.jobName))];
                         if (uniqueJob.length === 1) title = uniqueJob[0];
                    }
                }

                return (
                    <div className="min-h-screen bg-white text-black p-8 font-sans">
                        <div className="no-print flex justify-between items-center mb-8 bg-slate-100 p-4 rounded border">
                            <h2 className="font-bold">Preview ({pLogs.length} records)</h2>
                            <div className="flex gap-2"><button onClick={()=>window.print()} className={`px-4 py-2 text-white rounded ${theme.primary}`}>Print</button><button onClick={()=>setPrintMode(false)} className="px-4 py-2 border rounded bg-white text-black">Close</button></div>
                        </div>
                        <div className="flex justify-between items-end border-b-2 border-black pb-4 mb-6">
                            <div className="flex items-center gap-4">
                                {appSettings.reportLogo && appSettings.logoUrl && <img src={appSettings.logoUrl} className={`h-12 object-contain ${appSettings.invertLogoPrint ? 'invert' : ''}`}/>}
                                <div><h1 className="text-3xl font-bold uppercase tracking-tight">{title}</h1><p className="text-sm text-gray-500">Recycling Manifest</p></div>
                            </div>
                            <div className="text-right text-sm"><p>{new Date().toLocaleDateString('en-US')}</p><p className="font-bold">Total: {pLogs.reduce((a,l)=>a+Number(l.weight),0).toLocaleString()} lbs</p></div>
                        </div>
                        <table className="w-full text-left text-sm print-bordered">
                            <thead className="border-b-2 border-black"><tr><th>Date</th><th>Source</th><th>Manufacturer / Model</th>{appSettings.showDates && <th>Install / Exp / Status</th>}<th className="text-right">Unit Lbs</th><th className="text-right">Qty</th><th className="text-right">Total Lbs</th></tr></thead>
                            <tbody>{pLogs.map((l, idx) => (
                                <tr key={l.id} className={`border-b border-gray-100 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50 zebra-row'}`}>
                                    <td className="py-2">{l.dateStr}</td>
                                    <td className="py-2">{l.location}</td>
                                    <td className="py-2"><span className="font-bold">{l.manufacturer}</span> {l.batteryModel}</td>
                                    {appSettings.showDates && <td className="py-2 text-xs flex items-center gap-2">{formatDate(l.installDate) || '-'} / {formatDate(l.expiryDate) || '-'} <StatusIcon date={l.expiryDate}/></td>}
                                    <td className="py-2 text-right">{l.unitWeight}</td>
                                    <td className="py-2 text-right font-bold">{l.count}</td>
                                    <td className="py-2 text-right font-mono">{l.weight}</td>
                                </tr>
                            ))}</tbody>
                        </table>
                    </div>
                );
            }

            return (
                <div className={`${appSettings.fontStyle} text-sm md:text-base flex flex-col h-screen`}>
                    <div className={`z-50 sticky top-0 w-full p-3 md:px-6 flex justify-between items-center bg-slate-900 text-white shadow-md`}>
                        <div className="flex items-center space-x-3">
                            {appSettings.logoUrl ? <img src={appSettings.logoUrl} className="h-8 md:h-10 object-contain" /> : <div className={`p-2 rounded-lg ${theme.primary} text-white`}><Battery size={20}/></div>}
                            <h1 className="text-lg md:text-xl font-bold tracking-tight">{String(appSettings.companyName)}</h1>
                        </div>
                        <nav className="hidden md:flex gap-1">{['dashboard', 'log', 'database', 'archives', 'settings'].map(t => (<button key={t} onClick={() => setActiveTab(t)} className={`px-4 py-2 rounded-lg font-bold capitalize transition-all ${activeTab === t ? `${theme.primary} text-white shadow-md` : 'hover:bg-slate-800'}`}>{t}</button>))}</nav>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-slate-800 transition-colors">{isDarkMode ? <Sun size={20} className="text-amber-400" /> : <Moon size={20} className="text-slate-400" />}</button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8">
                        <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <div className="lg:col-span-2 space-y-6">
                                {activeTab === 'dashboard' && (
                                    <>
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card className={`p-6 border-l-4 ${theme.border}`}><p className="text-xs font-bold opacity-60 uppercase tracking-wider">Total Recycled</p><h3 className="text-3xl font-bold mt-1">{activeLogs.reduce((a,l)=>a+Number(l.weight),0).toLocaleString()} <span className="text-sm font-normal opacity-50">lbs</span></h3></Card>
                                            <Card className="p-6 border-l-4 border-slate-400 dark:border-slate-600"><p className="text-xs font-bold opacity-60 uppercase tracking-wider">Total Units</p><h3 className="text-3xl font-bold mt-1">{activeLogs.reduce((a,l)=>a+Number(l.count),0).toLocaleString()}</h3></Card>
                                        </div>
                                        <Card>
                                            <div className="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center"><h3 className="font-bold text-sm uppercase opacity-70">Active Manifests</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={completeJob} disabled={selectedLogIds.size===0} className={`flex items-center text-xs px-3 py-1.5 rounded font-bold text-white ${selectedLogIds.size > 0 ? theme.primary : 'bg-slate-400'}`}><Briefcase size={14} className="mr-1"/> Complete Job</button>
                                                    <button onClick={() => setPrintMode(true)} className="flex items-center text-xs bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded hover:opacity-80"><Printer size={14} className="mr-1"/> Print</button>
                                                </div>
                                            </div>
                                            <div className="overflow-x-auto max-h-[600px]">
                                                <table className="w-full text-left text-sm">
                                                    <thead className="bg-slate-50 dark:bg-slate-900/50 text-xs uppercase font-bold opacity-70 sticky top-0"><tr><th className="p-4 w-10"><button onClick={() => setSelectedLogIds(selectedLogIds.size === activeLogs.length ? new Set() : new Set(activeLogs.map(l => l.id)))}>{selectedLogIds.size === activeLogs.length && activeLogs.length > 0 ? <CheckSquare size={16} /> : <Square size={16} />}</button></th><th>Source / Model</th>{appSettings.showDates && <th>Dates</th>}<th className="text-right">Unit</th><th className="text-right">Qty</th><th className="text-right">Total</th><th className="p-4 text-center">Act</th></tr></thead>
                                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                                        {activeLogs.map((l, idx) => (
                                                            <tr key={l.id} className={`hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors ${idx % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50 dark:bg-slate-800/50'}`}>
                                                                <td className="p-4"><button onClick={() => setSelectedLogIds(p => { const n = new Set(p); n.has(l.id) ? n.delete(l.id) : n.add(l.id); return n; })}>{selectedLogIds.has(l.id) ? <CheckSquare size={16} className="text-emerald-500"/> : <Square size={16} className="text-slate-300"/>}</button></td>
                                                                <td><div className="font-bold flex items-center gap-2">{appSettings.showDates && <StatusIcon date={l.expiryDate} />} {l.location}</div><div className="text-xs opacity-60 ml-5">{l.manufacturer} {l.batteryModel}</div></td>
                                                                {appSettings.showDates && <td className="text-[10px] opacity-70">In: {formatDate(l.installDate) || '-'}<br/>Ex: {formatDate(l.expiryDate) || '-'}</td>}
                                                                <td className="text-right opacity-70">{l.unitWeight}</td><td className="text-right font-bold">{l.count}</td><td className="text-right font-mono font-bold text-emerald-600 dark:text-emerald-400">{l.weight}</td>
                                                                <td className="p-4 text-center flex justify-center gap-2"><button onClick={() => { setEditingId(l.id); setFormData(l); setActiveTab('log'); }} className="hover:text-blue-500"><Edit2 size={16}/></button><button onClick={() => toggleArchive(l.id, false)} className="hover:text-amber-500"><Archive size={16}/></button></td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </Card>
                                    </>
                                )}

                                {activeTab === 'log' && (
                                    <Card className="p-6 md:p-8 relative overflow-visible">
                                        <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-bold">{editingId ? 'Edit Entry' : 'New Manifest'}</h2><div className="flex gap-2"><label className={`flex items-center px-4 py-2 rounded-xl cursor-pointer shadow-lg transition-transform active:scale-95 ${scanning ? 'bg-slate-200' : `${theme.primary} text-white`}`}>{scanning ? <Loader2 className="animate-spin mr-2"/> : <Camera className="mr-2"/>}<span className="font-bold text-xs">{scanning ? 'Scanning...' : 'Scan Label'}</span><input type="file" accept="image/*" capture="environment" className="hidden" onChange={aiScan} disabled={scanning}/></label></div></div>
                                        <form onSubmit={saveRecord} className="space-y-6">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="relative"><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Battery Model</label><div className="flex gap-2"><input value={formData.batteryModel} onChange={(e) => handleModelSearch(e.target.value)} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="Type model..." /><button type="button" onClick={aiTextSearch} disabled={searchingModel} className="p-3 border rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">{searchingModel ? <Loader2 className="animate-spin"/> : <Sparkles className="text-amber-500"/>}</button></div>
                                                {suggestions.length > 0 && <div className="absolute z-50 w-full mt-2 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border dark:border-slate-700 max-h-60 overflow-y-auto p-1">{suggestions.map((s,i) => <div key={i} onClick={() => selectBattery(s)} className="p-3 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg cursor-pointer border-b dark:border-slate-700 last:border-0 flex justify-between"><span className="font-bold">{s.manufacturer} {s.model}</span><span className="text-xs opacity-50">{s.weight} lbs</span></div>)}</div>}</div>
                                                <div><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Manufacturer</label><input value={formData.manufacturer} onChange={e=>setFormData({...formData, manufacturer: e.target.value})} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900" /></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-6">
                                                <div><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Source / Customer</label><input list="sources" value={formData.location} onChange={e=>setFormData({...formData, location: e.target.value})} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900" /><datalist id="sources">{savedSources.map(s=><option key={s} value={s}/>)}</datalist></div>
                                                <div><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Type</label><select value={formData.type} onChange={e=>setFormData({...formData, type: e.target.value})} className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900"><option>Lead-Acid</option><option>Wet Cell</option><option>Li-ion</option></select></div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-4 bg-slate-100 dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                                                <div><label className="text-[10px] font-bold uppercase opacity-50">Unit Lbs</label><input type="number" step="0.1" value={formData.unitWeight} onChange={e=>setFormData({...formData, unitWeight: e.target.value})} className="w-full p-2 bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-emerald-500 outline-none font-mono font-bold" placeholder="0.0" /></div>
                                                <div><label className="text-[10px] font-bold uppercase opacity-50">Count</label><input type="number" value={formData.count} onChange={e=>setFormData({...formData, count: e.target.value})} className="w-full p-2 bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-emerald-500 outline-none font-mono font-bold" placeholder="0" /></div>
                                                <div><label className="text-[10px] font-bold uppercase opacity-50">Total Lbs</label><input readOnly value={formData.totalWeight} className="w-full p-2 bg-transparent border-b border-transparent font-mono font-bold text-emerald-600" /></div>
                                            </div>
                                            {appSettings.showDates && (<div className="grid grid-cols-2 gap-6 bg-slate-50 dark:bg-slate-800/30 p-3 rounded-xl border border-dashed border-slate-300 dark:border-slate-700">
                                                <div><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Install Date</label><input type="date" value={formData.installDate} onChange={e=>setFormData({...formData, installDate: e.target.value})} className="w-full p-2 rounded-lg border dark:border-slate-600 dark:bg-slate-800" /></div>
                                                <div><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Expected Life</label><input type="text" placeholder="e.g. 5 Years" value={formData.expectedLife} onChange={e=>setFormData({...formData, expectedLife: e.target.value})} className="w-full p-2 rounded-lg border dark:border-slate-600 dark:bg-slate-800" /></div>
                                                <div className="col-span-2"><label className="text-xs font-bold uppercase opacity-50 mb-1 block">Expiry (Auto-Calc)</label><input type="date" value={formData.expiryDate} onChange={e=>setFormData({...formData, expiryDate: e.target.value})} className="w-full p-2 rounded-lg border dark:border-slate-600 dark:bg-slate-800 font-bold text-slate-600 dark:text-slate-300" /></div>
                                            </div>)}
                                            <button type="submit" className={`w-full py-4 rounded-xl font-bold text-white shadow-xl transition-all hover:scale-[1.02] active:scale-95 ${theme.primary}`}>{editingId ? 'Update Entry' : 'Save to Manifest'}</button>
                                        </form>
                                    </Card>
                                )}

                                {activeTab === 'database' && (
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center">
                                            <div className="flex gap-2 p-1 bg-white dark:bg-slate-800 rounded-lg border dark:border-slate-700">
                                                <button onClick={() => setDbSubTab('explorer')} className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${dbSubTab === 'explorer' ? `${theme.primary} text-white shadow-md` : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>Explorer</button>
                                                <button onClick={() => setDbSubTab('library')} className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${dbSubTab === 'library' ? `${theme.primary} text-white shadow-md` : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>Library</button>
                                            </div>
                                            {dbSubTab === 'library' && <button onClick={() => setAddingLibItem(true)} className="flex items-center px-3 py-2 bg-emerald-500 text-white rounded-lg text-xs font-bold shadow hover:bg-emerald-600"><Plus size={14} className="mr-1"/> Add New</button>}
                                        </div>
                                        {addingLibItem && (
                                            <Card className="p-4 border-emerald-500 border-2">
                                                <h3 className="font-bold text-xs uppercase mb-3">New Library Spec</h3>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                                    <input placeholder="Manufacturer" value={newLibData.manufacturer} onChange={e=>setNewLibData({...newLibData, manufacturer: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900" />
                                                    <input placeholder="Model" value={newLibData.model} onChange={e=>setNewLibData({...newLibData, model: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900" />
                                                    <input placeholder="Lbs" type="number" value={newLibData.weight} onChange={e=>setNewLibData({...newLibData, weight: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900" />
                                                    <select value={newLibData.type} onChange={e=>setNewLibData({...newLibData, type: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900"><option>Lead-Acid</option><option>Wet Cell</option><option>Li-ion</option></select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 mb-3">
                                                    <input placeholder="Expected Life" value={newLibData.life} onChange={e=>setNewLibData({...newLibData, life: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900" />
                                                    <input placeholder="Amp Hours" value={newLibData.ah} onChange={e=>setNewLibData({...newLibData, ah: e.target.value})} className="p-2 text-xs rounded border dark:bg-slate-900" />
                                                </div>
                                                <div className="flex justify-end gap-2"><button onClick={() => setAddingLibItem(false)} className="px-3 py-1 text-xs border rounded">Cancel</button><button onClick={handleNewLibSubmit} className="px-3 py-1 text-xs bg-emerald-500 text-white rounded font-bold">Save Spec</button></div>
                                            </Card>
                                        )}
                                        <Card className="min-h-[400px]">
                                            <div className="p-4 border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex items-center"><Search size={14} className="opacity-50 mr-2"/><input placeholder="Search database..." value={dbSearch} onChange={e=>setDbSearch(e.target.value)} className="bg-transparent outline-none text-sm w-full" /></div>
                                            <div className="p-4 space-y-2 max-h-[600px] overflow-y-auto">
                                                {dbSubTab === 'explorer' ? Object.entries(groupedActive).map(([k,v]) => (
                                                    <div key={k} className="border dark:border-slate-700 rounded-lg overflow-hidden">
                                                        <button onClick={() => setExpandedFolders(p => { const n = new Set(p); n.has(k) ? n.delete(k) : n.add(k); return n; })} className="w-full p-3 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                            <div className="flex items-center gap-3"><Folder size={18} className="text-amber-400"/><span className="font-bold text-sm">{k}</span></div><span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded opacity-70">{v.length}</span>
                                                        </button>
                                                        {expandedFolders.has(k) && <div className="bg-slate-50 dark:bg-slate-900/50 border-t dark:border-slate-700">{v.map((l,idx) => <div key={l.id} className={`p-2 pl-10 text-xs border-b dark:border-slate-800 last:border-0 flex justify-between ${idx % 2 === 0 ? 'bg-slate-50/50 dark:bg-slate-900/50' : 'bg-transparent'}`}><span><span className="font-bold">{l.manufacturer}</span> {l.batteryModel}</span><span className="opacity-50">{l.weight} lbs</span></div>)}</div>}
                                                    </div>
                                                )) : Object.entries(groupedLib).map(([manuf, items]) => (
                                                    <div key={manuf} className="border dark:border-slate-700 rounded-lg overflow-hidden">
                                                        <button onClick={() => setExpandedLibFolders(p => { const n = new Set(p); n.has(manuf) ? n.delete(manuf) : n.add(manuf); return n; })} className="w-full p-3 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                                            <div className="flex items-center gap-3"><Folder size={18} className="text-blue-400"/><span className="font-bold text-sm">{manuf}</span></div><span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded opacity-70">{items.length}</span>
                                                        </button>
                                                        {expandedLibFolders.has(manuf) && (
                                                            <div className="bg-slate-50 dark:bg-slate-900/50 border-t dark:border-slate-700 p-2 grid grid-cols-1 gap-2">
                                                                {items.map((b,i) => (
                                                                    <div key={i} className={`p-2 bg-white dark:bg-slate-800 rounded border dark:border-slate-700 flex justify-between group cursor-pointer hover:border-emerald-500 ${i % 2 === 0 ? 'bg-slate-50 dark:bg-slate-900' : ''}`}>
                                                                        <div onClick={() => { setFormData({ batteryModel: b.model, manufacturer: b.manufacturer, type: b.type, unitWeight: String(b.weight), ampHours: String(b.ah||''), expectedLife: String(b.life||'') }); setActiveTab('log'); }}>
                                                                            <span className="text-xs font-bold block">{b.model}</span><span className="text-[10px] opacity-60">Type: {b.type}  {b.weight} lbs  Life: {b.life || 'N/A'}  AH: {b.ah || 'N/A'}</span>
                                                                        </div>
                                                                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100">
                                                                            <button onClick={(e) => handleEditLibItem(e, b)} className="hover:bg-slate-100 dark:hover:bg-slate-700 p-1 rounded"><MoreHorizontal size={14}/></button>
                                                                            {b.id && <button onClick={(e) => handleDeleteLibItem(e, b)} className="hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded text-red-500"><Trash2 size={14}/></button>}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </Card>
                                    </div>
                                )}

                                {activeTab === 'archives' && (
                                    <div className="space-y-4">
                                        <Card className="p-4">
                                            <div className="flex flex-wrap justify-between items-center mb-4 gap-2">
                                                <h3 className="font-bold text-xs uppercase opacity-50 flex items-center"><Archive size={14} className="mr-2"/> Archives</h3>
                                                <div className="flex gap-2 items-center">
                                                    <div className="flex items-center space-x-2 mr-4 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                                                        <span className="text-[10px] px-2 font-bold opacity-50">Report Header:</span>
                                                        <button onClick={() => setAppSettings(p => ({...p, dynamicReports: !p.dynamicReports}))} className={`w-8 h-4 rounded-full transition-colors ${appSettings.dynamicReports ? 'bg-emerald-500' : 'bg-slate-400'}`}><div className={`w-3 h-3 bg-white rounded-full shadow transition-transform ${appSettings.dynamicReports ? 'translate-x-4' : 'translate-x-0.5'} mt-0.5`}></div></button>
                                                    </div>
                                                    <div className="flex bg-slate-100 dark:bg-slate-800 rounded p-0.5">
                                                        <button onClick={() => setArchiveGroupBy('location')} className={`px-2 py-0.5 text-[10px] font-bold rounded ${archiveGroupBy === 'location' ? 'bg-white shadow text-black' : 'text-slate-400'}`}>Source</button>
                                                        <button onClick={() => setArchiveGroupBy('manufacturer')} className={`px-2 py-0.5 text-[10px] font-bold rounded ${archiveGroupBy === 'manufacturer' ? 'bg-white shadow text-black' : 'text-slate-400'}`}>Mfg</button>
                                                        <button onClick={() => setArchiveGroupBy('jobName')} className={`px-2 py-0.5 text-[10px] font-bold rounded ${archiveGroupBy === 'jobName' ? 'bg-white shadow text-black' : 'text-slate-400'}`}>Job</button>
                                                    </div>
                                                    <button onClick={() => setPrintMode(true)} disabled={selectedLogIds.size === 0} className={`flex items-center px-3 py-1.5 rounded text-xs font-bold ${selectedLogIds.size > 0 ? 'bg-emerald-500 text-white shadow' : 'bg-slate-100 text-slate-400'}`}><Printer className="mr-1" size={14}/> Report</button>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 mb-4">
                                                <button onClick={batchRestore} disabled={selectedLogIds.size === 0} className="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 disabled:opacity-50">Restore Selected</button>
                                                <button onClick={batchDelete} disabled={selectedLogIds.size === 0} className="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 disabled:opacity-50">Delete Selected</button>
                                            </div>
                                            {Object.entries(groupedArchive).map(([k,v]) => (
                                                <div key={k} className="border dark:border-slate-700 rounded-lg overflow-hidden mb-2">
                                                    <div className="p-3 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer" onClick={() => setExpandedFolders(p => { const n = new Set(p); n.has(k) ? n.delete(k) : n.add(k); return n; })}>
                                                        <div className="flex items-center gap-3">
                                                            <button onClick={(e) => { e.stopPropagation(); const ids = v.map(i=>i.id); setSelectedLogIds(p => { const n = new Set(p); const all = ids.every(x=>n.has(x)); ids.forEach(x => all ? n.delete(x) : n.add(x)); return n; }); }}>{v.every(i => selectedLogIds.has(i.id)) ? <CheckSquare size={16} className="text-emerald-500"/> : <Square size={16} className="text-slate-300"/>}</button>
                                                            <span className="font-bold text-sm">{k}</span>
                                                        </div>
                                                        <span className="text-[10px] opacity-50">{v.length} items</span>
                                                    </div>
                                                    {expandedFolders.has(k) && v.map((l, idx) => (
                                                        <div key={l.id} className={`flex justify-between items-center px-10 py-2 border-t dark:border-slate-800 text-xs ${idx % 2 === 0 ? 'bg-slate-50 dark:bg-slate-900' : 'bg-white dark:bg-slate-800'}`}>
                                                            <div className="flex gap-3 items-center"><button onClick={() => setSelectedLogIds(p => { const n = new Set(p); n.has(l.id) ? n.delete(l.id) : n.add(l.id); return n; })}>{selectedLogIds.has(l.id) ? <CheckSquare size={14} className="text-emerald-500"/> : <Square size={14} className="text-slate-300"/>}</button><span><span className="font-bold">{l.manufacturer}</span> {l.batteryModel}</span></div>
                                                            <div className="flex gap-3"><span className="font-mono opacity-50">{l.weight} lbs</span><button onClick={() => toggleArchive(l.id, true)} className="text-emerald-500 hover:underline font-bold">Restore</button></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </Card>
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <Card className="p-8">
                                        <h2 className="text-xl font-bold mb-6">Configuration</h2>
                                        <div className="grid md:grid-cols-2 gap-8 mb-8">
                                            <div className="space-y-4">
                                                <label className="text-xs font-bold block opacity-60">Company Name</label>
                                                <input value={appSettings.companyName} onChange={e => setAppSettings({...appSettings, companyName: e.target.value})} className="w-full p-3 rounded-lg border dark:bg-slate-900 dark:border-slate-700" />
                                                <label className="text-xs font-bold block opacity-60">Logo URL</label>
                                                <input value={appSettings.logoUrl} onChange={e => setAppSettings({...appSettings, logoUrl: e.target.value})} className="w-full p-3 rounded-lg border dark:bg-slate-900 dark:border-slate-700" />
                                            </div>
                                            <div className="space-y-4">
                                                <div className="flex items-center justify-between p-3 border rounded-lg dark:border-slate-700">
                                                    <span className="text-sm font-bold">Track Dates (Install/Exp)</span>
                                                    <button onClick={() => setAppSettings(p => ({...p, showDates: !p.showDates}))} className={`w-10 h-6 rounded-full p-1 transition-colors ${appSettings.showDates ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transition-transform ${appSettings.showDates ? 'translate-x-4' : ''}`}></div></button>
                                                </div>
                                                <div className="flex items-center justify-between p-3 border rounded-lg dark:border-slate-700">
                                                    <span className="text-sm font-bold">Show Logo on Report</span>
                                                    <button onClick={() => setAppSettings(p => ({...p, reportLogo: !p.reportLogo}))} className={`w-10 h-6 rounded-full p-1 transition-colors ${appSettings.reportLogo ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transition-transform ${appSettings.reportLogo ? 'translate-x-4' : ''}`}></div></button>
                                                </div>
                                                <div className="flex items-center justify-between p-3 border rounded-lg dark:border-slate-700">
                                                    <span className="text-sm font-bold">Invert Logo on Print</span>
                                                    <button onClick={() => setAppSettings(p => ({...p, invertLogoPrint: !p.invertLogoPrint}))} className={`w-10 h-6 rounded-full p-1 transition-colors ${appSettings.invertLogoPrint ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transition-transform ${appSettings.invertLogoPrint ? 'translate-x-4' : ''}`}></div></button>
                                                </div>
                                                <div className="flex items-center justify-between p-3 border rounded-lg dark:border-slate-700">
                                                    <span className="text-sm font-bold">Show Safety Protocols</span>
                                                    <button onClick={() => setAppSettings(p => ({...p, showProtocols: !p.showProtocols}))} className={`w-10 h-6 rounded-full p-1 transition-colors ${appSettings.showProtocols ? 'bg-emerald-500' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow-md transition-transform ${appSettings.showProtocols ? 'translate-x-4' : ''}`}></div></button>
                                                </div>
                                                <div className="pt-2"><span className="text-xs font-bold opacity-60 block mb-2">Accent Color</span>
                                                    <div className="flex gap-2">{Object.keys(THEMES).map(c => <button key={c} onClick={() => setAppSettings({...appSettings, themeColor: c})} className={`w-8 h-8 rounded-full border-2 ${c === 'emerald' ? 'bg-emerald-500' : c === 'blue' ? 'bg-blue-500' : c === 'violet' ? 'bg-violet-500' : 'bg-slate-600'} ${appSettings.themeColor === c ? 'border-white ring-2 ring-slate-400' : 'border-transparent'}`} />)}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={saveSettings} className={`px-8 py-3 rounded-xl font-bold text-white shadow-lg transition-transform hover:scale-105 ${theme.primary}`}>Save All Changes</button>
                                        
                                        <div className="mt-12 pt-8 border-t dark:border-slate-700 text-center">
                                            <p className="font-bold text-slate-500 text-xs uppercase tracking-wider mb-2">About</p>
                                            <h3 className="text-lg font-bold text-slate-700 dark:text-slate-300">CTRL Inc.</h3>
                                            <p className="text-xs text-slate-400">Battery Recycling Management System v2.0</p>
                                            
                                            <div className="mt-6 flex justify-center gap-8">
                                                <div className="text-center">
                                                    <p className="text-2xl font-bold text-emerald-500">{Math.round(allTimeStats.weight).toLocaleString()}</p>
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">All-Time Lbs</p>
                                                </div>
                                                <div className="text-center">
                                                    <p className="text-2xl font-bold text-blue-500">{allTimeStats.count.toLocaleString()}</p>
                                                    <p className="text-[10px] uppercase font-bold text-slate-400">All-Time Units</p>
                                                </div>
                                            </div>
                                        </div>
                                    </Card>
                                )}
                            </div>

                        </div>
                    </div>
                    
                    {/* Mobile Bottom Nav */}
                    <div className="md:hidden fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 p-2 flex justify-around z-50">
                        {['dashboard', 'log', 'database', 'archives', 'settings'].map(t => (
                            <button key={t} onClick={() => setActiveTab(t)} className={`p-2 rounded-xl flex flex-col items-center ${activeTab === t ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}`}>
                                {t==='dashboard' && <BarChart3 size={20}/>}
                                {t==='log' && <Plus size={20}/>}
                                {t==='database' && <Database size={20}/>}
                                {t==='archives' && <Archive size={20}/>}
                                {t==='settings' && <Settings size={20}/>}
                                <span className="text-[10px] font-bold capitalize mt-1">{t}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
